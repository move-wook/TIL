# Sticky Session 운영 방식에 대한 기술 문서 (NCP L7 기준)

## 1. 개요

본 문서는 NCP(Naver Cloud Platform) 환경에서 L7 로드밸런서의 Sticky Session 설정 방식과 그 기술적 원리에 대해 설명하고, 해당 방식의 운영 한계 및 대안 방안을 제시한다. Sticky Session은 세션 상태가 서버 메모리에 저장되는 구조에서 이중화된 WAS 간 세션 일관성을 유지하기 위한 단기적 운영 기법이다.

---

## 2. Sticky Session이란

Sticky Session(세션 고정화)은 클라이언트의 연속적인 요청을 항상 동일한 서버 인스턴스로 라우팅하는 로드밸런서의 기능이다. 이를 통해 사용자는 WAS 클러스터 중 하나의 서버에서 생성된 세션 상태를 유지하며 일관된 서비스를 제공받을 수 있다.

---

## 3. Sticky Session의 동작 방식 (NCP 기준)

NCP의 L7 로드밸런서에서는 다음 두 가지 방식의 Sticky Session 설정이 가능하다:

### 3.1. 쿠키 기반 세션 고정화

- 클라이언트 요청 시 WAS가 `Set-Cookie: JSESSIONID=<value>` 를 포함한 응답을 전송
- L7은 해당 쿠키를 기반으로 클라이언트를 특정 서버 인스턴스로 고정
- 이후 동일한 `JSESSIONID`를 가진 요청은 항상 동일 서버로 전달

### 3.2. 소스 IP 기반 세션 고정화

- 클라이언트의 IP 주소를 기준으로 세션 고정
- 동일 IP의 요청은 항상 동일 서버로 라우팅됨
- 다만, NAT 및 공유망 환경에서는 동일한 IP를 여러 사용자가 사용할 수 있어 정확성이 낮음

---

## 4. Sticky Session 사용 시 고려사항

### 4.1. 장점

- 별도 세션 저장소 없이도 세션 일관성 확보 가능
- 구조적 변경 없이 기존 WAS 아키텍처 활용 가능
- 단기적 문제 우회 및 빠른 도입 가능

### 4.2. 단점 및 한계

| 항목 | 내용 |
|------|------|
| 세션 유실 가능성 | 서버 재시작 시 메모리 기반 세션 소멸 |
| 확장성 제약 | 고정 라우팅으로 로드밸런싱 효과 저하 |
| 상태 의존 구조 | Stateless 구조 설계와 상충 |
| 운영 복잡도 증가 | 장애 발생 시 특정 서버에만 세션 묶여 복구 어려움 |
| Cross-Origin 연동 시 쿠키 미전송 가능성 | `SameSite` 정책, CORS 설정 누락 시 쿠키가 서버에 전달되지 않음 |

---

## 5. 대안: Redis 기반 세션 공유

Sticky Session의 구조적 한계를 해결하기 위해, 다음과 같은 대안을 권장한다:

### 5.1. Redis 기반 세션 저장소 도입

- 각 WAS는 `HttpSession` 객체를 Redis에 저장
- 모든 서버가 동일한 세션 저장소를 참조하여 세션 일관성 확보
- 서버 수 증가/감소와 무관하게 동일 세션 데이터 사용 가능

### 5.2. 구성 예시

- WAS: eGovFrame 기반 Spring 또는 Servlet 환경
- 세션 저장 방식: Redis 연동 (Spring Session 등 사용 가능)
- 클라이언트: React (iframe 내 API 호출) → `withCredentials: true` 설정 필수
- 서버: `Set-Cookie: JSESSIONID=...; SameSite=None; Secure` 및 CORS 설정 필요

---

## 6. Sticky Session vs Redis 세션 비교

| 항목 | Sticky Session | Redis 기반 세션 |
|------|----------------|------------------|
| 도입 난이도 | 낮음 (L7 설정) | 중간 (Redis 연동 필요) |
| 확장성 | 낮음 | 높음 |
| 장애 복원성 | 낮음 | 높음 (세션 손실 없음) |
| Stateless 설계 호환성 | 불가능 | 가능 |
| 유지보수 | 분기 처리 필요 | 단일 구조로 일관성 있음 |

---

## 7. 결론

Sticky Session은 로드밸런서 기반의 간단한 세션 일관성 유지 방식이지만, 상태 저장 기반 아키텍처라는 구조적 한계를 가진다. 운영 환경의 고가용성, 확장성, 유지보수성을 고려할 때, Redis와 같은 중앙 세션 저장소 도입이 중장기적으로 더 안정적인 구조를 제공한다.

---
